#!/bin/bash
# ALFIS Dock App - Simple Background Service

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ALFIS_BINARY="$SCRIPT_DIR/alfis-binary"
PID_FILE="$HOME/.alfis/alfis.pid"
LOG_FILE="$HOME/.alfis/alfis.log"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ ALFIS –≤ —Ñ–æ–Ω–µ
start_background() {
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    mkdir -p "$HOME/.alfis"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥
    if [ ! -f "$HOME/.alfis/alfis.toml" ]; then
        osascript -e 'display dialog "Creating ALFIS configuration..." buttons {"OK"} default button "OK" with icon note'
        "$ALFIS_BINARY" --generate > "$HOME/.alfis/alfis.toml"
    fi
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º ALFIS –≤ —Ñ–æ–Ω–µ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    cd "$HOME/.alfis"
    nohup "$ALFIS_BINARY" > "$LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    osascript -e 'display notification "ALFIS started in background" with title "ALFIS" subtitle "DNS + Mining + P2P Active"'
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
stop_background() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            kill "$PID"
            rm -f "$PID_FILE"
            osascript -e 'display notification "ALFIS stopped" with title "ALFIS"'
        fi
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞
show_status() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
            CPU=$(ps -p "$PID" -o %cpu= | tr -d ' ')
            MEM=$(ps -p "$PID" -o %mem= | tr -d ' ')
            
            osascript -e 'display dialog "ALFIS Background Service:\n\n‚úÖ Running (PID: '"$PID"')\nüìä CPU: '"$CPU"'%\nüíæ Memory: '"$MEM"'%\n\nüåê DNS Resolution: Active\n‚õèÔ∏è Mining: Active\nüîó P2P Network: Active\n\nAll services running in background!" buttons {"OK"} default button "OK" with icon note'
        else
            osascript -e 'display dialog "ALFIS Background Service:\n\n‚ùå Not Running\n\nService is stopped." buttons {"OK"} default button "OK" with icon stop'
        fi
    else
        osascript -e 'display dialog "ALFIS Background Service:\n\n‚ùå Not Running\n\nService is stopped." buttons {"OK"} default button "OK" with icon stop'
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ–≤
show_logs() {
    if [ -f "$LOG_FILE" ]; then
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞
        tail -15 "$LOG_FILE" | osascript -e 'set logText to (do shell script "tail -15 ~/.alfis/alfis.log")
display dialog "ALFIS Service Logs (last 15 lines):\n\n" & logText buttons {"OK"} default button "OK" with icon note'
    else
        osascript -e 'display dialog "No log file found.\n\nALFIS service may not be running." buttons {"OK"} default button "OK" with icon stop'
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
restart_background() {
    stop_background
    sleep 2
    start_background
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
case "$1" in
    "start")
        start_background
        ;;
    "stop")
        stop_background
        ;;
    "status")
        show_status
        ;;
    "logs")
        show_logs
        ;;
    "restart")
        restart_background
        ;;
    *)
        # –ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
        show_status
        ;;
esac
