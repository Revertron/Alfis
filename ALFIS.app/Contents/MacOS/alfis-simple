#!/bin/bash
# ALFIS Simple Dock App

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ALFIS_BINARY="$SCRIPT_DIR/alfis-binary"
PID_FILE="$HOME/.alfis/alfis.pid"

# Функция для запуска ALFIS
start_alfis() {
    mkdir -p "$HOME/.alfis"
    
    if [ ! -f "$HOME/.alfis/alfis.toml" ]; then
        osascript -e 'display dialog "Creating configuration file..." buttons {"OK"} default button "OK" with icon note'
        "$ALFIS_BINARY" --generate > "$HOME/.alfis/alfis.toml"
    fi
    
    cd "$HOME/.alfis"
    "$ALFIS_BINARY" &
    echo $! > "$PID_FILE"
    
    osascript -e 'display notification "ALFIS started - running in background" with title "ALFIS" subtitle "P2P Network Active"'
}

# Функция для остановки ALFIS
stop_alfis() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            kill "$PID"
            rm -f "$PID_FILE"
            osascript -e 'display notification "ALFIS stopped" with title "ALFIS"'
        fi
    fi
}

# Функция для показа статуса
show_status() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            osascript -e 'display notification "ALFIS is running (PID: '"$PID"')" with title "ALFIS Status"'
        else
            osascript -e 'display notification "ALFIS is not running" with title "ALFIS Status"'
        fi
    else
        osascript -e 'display notification "ALFIS is not running" with title "ALFIS Status"'
    fi
}

# Основная логика
case "$1" in
    "start")
        start_alfis
        ;;
    "stop")
        stop_alfis
        ;;
    "status")
        show_status
        ;;
    "restart")
        stop_alfis
        sleep 2
        start_alfis
        ;;
    *)
        # Если запущено без аргументов, показываем статус
        show_status
        ;;
esac
